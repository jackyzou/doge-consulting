name: CI/CD — Test & Deploy

on:
  push:
    branches: [master]

# Cancel any in-progress runs for the same branch
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-and-deploy:
    name: Test → Build → Deploy
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 15

    env:
      NODE_ENV: test

    steps:
      # ── Checkout & setup ──────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # ── Install & generate ────────────────────────────────────
      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      # ── Test ──────────────────────────────────────────────────
      - name: Run unit tests
        run: npx vitest run

      # ── Deploy to production ──────────────────────────────────
      - name: Deploy
        shell: powershell
        env:
          DOGE_SERVICE_PATH: ${{ vars.DOGE_SERVICE_PATH || 'C:\doge-consulting' }}
        run: |
          $ErrorActionPreference = "Stop"
          $ServiceDir = $env:DOGE_SERVICE_PATH

          Write-Host "=== Deploying to $ServiceDir ===" -ForegroundColor Cyan

          # 1. Pull latest code in the service directory
          Write-Host "Pulling latest code..." -ForegroundColor Yellow
          git -C $ServiceDir pull origin master

          # 2. Install production dependencies
          Write-Host "Installing dependencies..." -ForegroundColor Yellow
          Push-Location $ServiceDir
          npm ci
          npx prisma generate

          # 3. Run database migrations
          Write-Host "Running migrations..." -ForegroundColor Yellow
          npx prisma migrate deploy

          # 4. Build
          Write-Host "Building Next.js..." -ForegroundColor Yellow
          npm run build
          Pop-Location

          # 5. Restart the Windows service
          Write-Host "Restarting service..." -ForegroundColor Yellow
          $svc = Get-Service DogeConsulting -ErrorAction SilentlyContinue
          if ($svc) {
            Restart-Service DogeConsulting -Force
            Start-Sleep -Seconds 5
          } else {
            Write-Host "Service not installed — skipping restart" -ForegroundColor Red
            exit 0
          }

          # 6. Health check
          Write-Host "Health check..." -ForegroundColor Yellow
          $retries = 0
          $healthy = $false
          while ($retries -lt 10 -and -not $healthy) {
            Start-Sleep -Seconds 3
            try {
              $resp = Invoke-RestMethod -Uri "http://localhost:3000/api/health" -TimeoutSec 5
              if ($resp.status -eq "ok") { $healthy = $true }
            } catch { $retries++ }
          }

          if ($healthy) {
            Write-Host "=== Deploy successful! ===" -ForegroundColor Green
          } else {
            Write-Host "=== Health check failed after 30s ===" -ForegroundColor Red
            exit 1
          }
